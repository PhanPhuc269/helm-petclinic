apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: grafana
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://grafana.github.io/helm-charts
    chart: grafana
    targetRevision: 7.0.0
    helm:
      values: |
        ingress:
          enabled: true
          hosts:
            - grafana.phanphuc.id.vn
          ingressClassName: nginx
          path: /
          pathType: Prefix
        service:
          type: NodePort
          nodePort: 32000
        datasources:
          datasources.yaml:
            apiVersion: 1
            datasources:
              - name: Loki
                type: loki
                access: proxy
                url: http://loki.monitoring:3100
                isDefault: false
                editable: true
              - name: Prometheus
                type: prometheus
                access: proxy
                url: http://prometheus-server.monitoring:80
                isDefault: true
                editable: true
        dashboardProviders:
          dashboardproviders.yaml:
            apiVersion: 1
            providers:
            - name: 'default'
              orgId: 1
              folder: ''
              type: file
              disableDeletion: false
              editable: true
              options:
                path: /var/lib/grafana/dashboards/default

        dashboards:
          default:
            petclinic-traffic-logs:
              json: |
                {
                  "title": "Petclinic Traffic & Logs",
                  "uid": "petclinic-traffic-logs",
                  "schemaVersion": 16,
                  "version": 1,
                  "templating": {
                    "list": [
                      {
                        "name": "interval",
                        "type": "interval",
                        "label": "Khoảng thời gian",
                        "query": "1m,5m,15m,1h,6h,1d",
                        "current": { "text": "1m", "value": "1m" }
                      }
                    ]
                  },
                  "panels": [
                    {
                      "type": "graph",
                      "title": "HTTP Request Count",
                      "datasource": "Prometheus",
                      "targets": [
                        {
                          "expr": "sum(http_server_requests_seconds_count)",
                          "legendFormat": "Tổng request"
                        },
                        {
                          "expr": "sum(http_server_requests_seconds_count{status=~\"2..\"})",
                          "legendFormat": "Request 2xx"
                        },
                        {
                          "expr": "sum(http_server_requests_seconds_count{status=~\"5..\"})",
                          "legendFormat": "Request 5xx"
                        }
                      ],
                      "gridPos": {
                        "h": 8,
                        "w": 24,
                        "x": 0,
                        "y": 0
                      }
                    },
                    {
                      "type": "logs",
                      "title": "Application Logs",
                      "datasource": "Loki",
                      "targets": [
                        {
                          "datasource": {
                            "type": "loki",
                            "uid": "P8E80F9AEF21F6940"
                          },
                          "editorMode": "code",
                          "expr": "{app=\"api-gateway\"} |= ``",
                          "queryType": "range",
                          "refId": "A"
                        },
                        {
                          "datasource": {
                            "type": "loki",
                            "uid": "P8E80F9AEF21F6940"
                          },
                          "editorMode": "builder",
                          "expr": "{app=\"admin-server\"} |= ``",
                          "hide": false,
                          "queryType": "range",
                          "refId": "B"
                        },
                        {
                          "datasource": {
                            "type": "loki",
                            "uid": "P8E80F9AEF21F6940"
                          },
                          "editorMode": "builder",
                          "expr": "{app=\"customers-service\"} |= ``",
                          "hide": false,
                          "queryType": "range",
                          "refId": "C"
                        },
                        {
                          "datasource": {
                            "type": "loki",
                            "uid": "P8E80F9AEF21F6940"
                          },
                          "editorMode": "builder",
                          "expr": "{app=\"vets-service\"} |= ``",
                          "hide": false,
                          "queryType": "range",
                          "refId": "D"
                        },
                        {
                          "datasource": {
                            "type": "loki",
                            "uid": "P8E80F9AEF21F6940"
                          },
                          "editorMode": "builder",
                          "expr": "{app=\"visits-service\"} |= ``",
                          "hide": false,
                          "queryType": "range",
                          "refId": "E"
                        },
                        {
                          "datasource": {
                            "type": "loki",
                            "uid": "P8E80F9AEF21F6940"
                          },
                          "editorMode": "builder",
                          "expr": "{app=\"discovery-server\"} |= ``",
                          "hide": false,
                          "queryType": "range",
                          "refId": "F"
                        }
                      ],
                      "gridPos": {
                        "h": 10,
                        "w": 24,
                        "x": 0,
                        "y": 8
                      }
                    }
                  ]
                }
            petclinic-dashboard:
              json: |
                {
                  "__requires": [
                    {
                      "type": "grafana",
                      "id": "grafana",
                      "name": "Grafana",
                      "version": "5.0.0"
                    },
                    {
                      "type": "panel",
                      "id": "graph",
                      "name": "Graph",
                      "version": "5.0.0"
                    },
                    {
                      "type": "datasource",
                      "id": "prometheus",
                      "name": "Prometheus",
                      "version": "5.0.0"
                    },
                    {
                      "type": "panel",
                      "id": "singlestat",
                      "name": "Singlestat",
                      "version": "5.0.0"
                    }
                  ],
                  "annotations": {
                    "list": [
                      {
                        "builtIn": 1,
                        "datasource": "-- Grafana --",
                        "enable": true,
                        "hide": true,
                        "iconColor": "rgba(0, 211, 255, 1)",
                        "name": "Annotations & Alerts",
                        "type": "dashboard"
                      }
                    ]
                  },
                  "editable": true,
                  "gnetId": null,
                  "graphTooltip": 0,
                  "id": null,
                  "iteration": 1539967676482,
                  "links": [],
                  "panels": [
                    {
                      "aliasColors": {},
                      "bars": false,
                      "dashLength": 10,
                      "dashes": false,
                      "datasource": "Prometheus",
                      "fill": 1,
                      "gridPos": {
                        "h": 9,
                        "w": 12,
                        "x": 0,
                        "y": 0
                      },
                      "id": 11,
                      "legend": {
                        "avg": false,
                        "current": true,
                        "max": false,
                        "min": false,
                        "show": true,
                        "total": false,
                        "values": true
                      },
                      "lines": true,
                      "linewidth": 1,
                      "links": [],
                      "nullPointMode": "null",
                      "percentage": false,
                      "pointradius": 5,
                      "points": false,
                      "renderer": "flot",
                      "seriesOverrides": [],
                      "spaceLength": 10,
                      "stack": false,
                      "steppedLine": false,
                      "targets": [
                        {
                          "expr": "sum(rate(http_server_requests_seconds_sum{status!~\"5..\"}[1m]))/sum(rate(http_server_requests_seconds_count{ status!~\"5..\"}[1m]))",
                          "format": "time_series",
                          "intervalFactor": 1,
                          "legendFormat": "HTTP - AVG",
                          "refId": "A"
                        },
                        {
                          "expr": "max(http_server_requests_seconds_max{status!~\"5..\"})",
                          "format": "time_series",
                          "intervalFactor": 1,
                          "legendFormat": "HTTP - MAX",
                          "refId": "B"
                        }
                      ],
                      "thresholds": [],
                      "timeFrom": null,
                      "timeShift": null,
                      "title": "HTTP Request Latency",
                      "tooltip": {
                        "shared": true,
                        "sort": 0,
                        "value_type": "individual"
                      },
                      "type": "graph",
                      "xaxis": {
                        "buckets": null,
                        "mode": "time",
                        "name": null,
                        "show": true,
                        "values": []
                      },
                      "yaxes": [
                        {
                          "decimals": null,
                          "format": "s",
                          "label": null,
                          "logBase": 1,
                          "max": null,
                          "min": "0",
                          "show": true
                        },
                        {
                          "format": "short",
                          "label": null,
                          "logBase": 1,
                          "max": null,
                          "min": null,
                          "show": true
                        }
                      ]
                    },
                    {
                      "aliasColors": {},
                      "bars": false,
                      "dashLength": 10,
                      "dashes": false,
                      "datasource": "Prometheus",
                      "fill": 1,
                      "gridPos": {
                        "h": 9,
                        "w": 12,
                        "x": 12,
                        "y": 0
                      },
                      "id": 9,
                      "legend": {
                        "avg": false,
                        "current": true,
                        "max": true,
                        "min": false,
                        "show": true,
                        "total": false,
                        "values": true
                      },
                      "lines": true,
                      "linewidth": 1,
                      "links": [],
                      "nullPointMode": "null",
                      "percentage": false,
                      "pointradius": 0.5,
                      "points": true,
                      "renderer": "flot",
                      "seriesOverrides": [],
                      "spaceLength": 10,
                      "stack": false,
                      "steppedLine": false,
                      "targets": [
                        {
                          "expr": "sum(rate(http_server_requests_seconds_count[1m]))",
                          "format": "time_series",
                          "interval": "",
                          "intervalFactor": 1,
                          "legendFormat": "request - ok",
                          "refId": "A"
                        },
                        {
                          "expr": "sum(rate(http_server_requests_seconds_count{status=~\"5..\"}[1m]))",
                          "format": "time_series",
                          "interval": "",
                          "intervalFactor": 1,
                          "legendFormat": "request - err",
                          "refId": "B"
                        }
                      ],
                      "thresholds": [],
                      "timeFrom": null,
                      "timeShift": null,
                      "title": "HTTP Request Activity",
                      "tooltip": {
                        "shared": true,
                        "sort": 0,
                        "value_type": "individual"
                      },
                      "type": "graph",
                      "xaxis": {
                        "buckets": null,
                        "mode": "time",
                        "name": null,
                        "show": true,
                        "values": []
                      },
                      "yaxes": [
                        {
                          "format": "ops",
                          "label": null,
                          "logBase": 1,
                          "max": null,
                          "min": "0",
                          "show": true
                        },
                        {
                          "format": "short",
                          "label": null,
                          "logBase": 1,
                          "max": null,
                          "min": null,
                          "show": true
                        }
                      ]
                    },
                    {
                      "cacheTimeout": null,
                      "colorBackground": false,
                      "colorValue": false,
                      "colors": [
                        "#299c46",
                        "rgba(237, 129, 40, 0.89)",
                        "#d44a3a"
                      ],
                      "datasource": "Prometheus",
                      "format": "none",
                      "gauge": {
                        "maxValue": 100,
                        "minValue": 0,
                        "show": false,
                        "thresholdLabels": false,
                        "thresholdMarkers": true
                      },
                      "gridPos": {
                        "h": 5,
                        "w": 6,
                        "x": 0,
                        "y": 9
                      },
                      "id": 2,
                      "interval": null,
                      "links": [],
                      "mappingType": 1,
                      "mappingTypes": [
                        {
                          "name": "value to text",
                          "value": 1
                        },
                        {
                          "name": "range to text",
                          "value": 2
                        }
                      ],
                      "maxDataPoints": 100,
                      "nullPointMode": "connected",
                      "nullText": null,
                      "postfix": "",
                      "postfixFontSize": "50%",
                      "prefix": "",
                      "prefixFontSize": "50%",
                      "rangeMaps": [
                        {
                          "from": "null",
                          "text": "N/A",
                          "to": "null"
                        }
                      ],
                      "sparkline": {
                        "fillColor": "rgba(31, 118, 189, 0.18)",
                        "full": false,
                        "lineColor": "rgb(31, 120, 193)",
                        "show": false
                      },
                      "tableColumn": "",
                      "targets": [
                        {
                          "expr": "sum(petclinic_owner_seconds_count{method=\"updateOwner\", exception=\"none\"})",
                          "format": "time_series",
                          "instant": true,
                          "intervalFactor": 1,
                          "refId": "A"
                        }
                      ],
                      "thresholds": "",
                      "title": "Owners Updated",
                      "type": "singlestat",
                      "valueFontSize": "80%",
                      "valueMaps": [
                        {
                          "op": "=",
                          "text": "N/A",
                          "value": "null"
                        }
                      ],
                      "valueName": "avg"
                    },
                    {
                      "cacheTimeout": null,
                      "colorBackground": false,
                      "colorValue": false,
                      "colors": [
                        "#299c46",
                        "rgba(237, 129, 40, 0.89)",
                        "#d44a3a"
                      ],
                      "datasource": "Prometheus",
                      "format": "none",
                      "gauge": {
                        "maxValue": 100,
                        "minValue": 0,
                        "show": false,
                        "thresholdLabels": false,
                        "thresholdMarkers": true
                      },
                      "gridPos": {
                        "h": 5,
                        "w": 6,
                        "x": 6,
                        "y": 9
                      },
                      "id": 3,
                      "interval": null,
                      "links": [],
                      "mappingType": 1,
                      "mappingTypes": [
                        {
                          "name": "value to text",
                          "value": 1
                        },
                        {
                          "name": "range to text",
                          "value": 2
                        }
                      ],
                      "maxDataPoints": 100,
                      "nullPointMode": "connected",
                      "nullText": null,
                      "postfix": "",
                      "postfixFontSize": "50%",
                      "prefix": "",
                      "prefixFontSize": "50%",
                      "rangeMaps": [
                        {
                          "from": "null",
                          "text": "N/A",
                          "to": "null"
                        }
                      ],
                      "sparkline": {
                        "fillColor": "rgba(31, 118, 189, 0.18)",
                        "full": false,
                        "lineColor": "rgb(31, 120, 193)",
                        "show": false
                      },
                      "tableColumn": "",
                      "targets": [
                        {
                          "expr": "sum(petclinic_owner_seconds_count{method=\"createOwner\", exception=\"none\"})",
                          "format": "time_series",
                          "instant": true,
                          "intervalFactor": 1,
                          "legendFormat": "",
                          "refId": "A"
                        }
                      ],
                      "thresholds": "",
                      "title": "Owners Created",
                      "type": "singlestat",
                      "valueFontSize": "80%",
                      "valueMaps": [
                        {
                          "op": "=",
                          "text": "N/A",
                          "value": "null"
                        }
                      ],
                      "valueName": "avg"
                    },
                    {
                      "cacheTimeout": null,
                      "colorBackground": false,
                      "colorValue": false,
                      "colors": [
                        "#299c46",
                        "rgba(237, 129, 40, 0.89)",
                        "#d44a3a"
                      ],
                      "datasource": "Prometheus",
                      "format": "none",
                      "gauge": {
                        "maxValue": 100,
                        "minValue": 0,
                        "show": false,
                        "thresholdLabels": false,
                        "thresholdMarkers": true
                      },
                      "gridPos": {
                        "h": 5,
                        "w": 6,
                        "x": 12,
                        "y": 9
                      },
                      "id": 4,
                      "interval": null,
                      "links": [],
                      "mappingType": 1,
                      "mappingTypes": [
                        {
                          "name": "value to text",
                          "value": 1
                        },
                        {
                          "name": "range to text",
                          "value": 2
                        }
                      ],
                      "maxDataPoints": 100,
                      "nullPointMode": "connected",
                      "nullText": null,
                      "postfix": "",
                      "postfixFontSize": "50%",
                      "prefix": "",
                      "prefixFontSize": "50%",
                      "rangeMaps": [
                        {
                          "from": "null",
                          "text": "N/A",
                          "to": "null"
                        }
                      ],
                      "sparkline": {
                        "fillColor": "rgba(31, 118, 189, 0.18)",
                        "full": false,
                        "lineColor": "rgb(31, 120, 193)",
                        "show": false
                      },
                      "tableColumn": "",
                      "targets": [
                        {
                          "expr": "sum(petclinic_pet_seconds_count{method=\"processCreationForm\", exception=\"none\"})",
                          "format": "time_series",
                          "instant": true,
                          "intervalFactor": 1,
                          "legendFormat": "",
                          "refId": "A"
                        }
                      ],
                      "thresholds": "",
                      "title": "Pets Created",
                      "type": "singlestat",
                      "valueFontSize": "80%",
                      "valueMaps": [
                        {
                          "op": "=",
                          "text": "N/A",
                          "value": "null"
                        }
                      ],
                      "valueName": "avg"
                    },
                    {
                      "cacheTimeout": null,
                      "colorBackground": false,
                      "colorValue": false,
                      "colors": [
                        "#299c46",
                        "rgba(237, 129, 40, 0.89)",
                        "#d44a3a"
                      ],
                      "datasource": "Prometheus",
                      "format": "none",
                      "gauge": {
                        "maxValue": 100,
                        "minValue": 0,
                        "show": false,
                        "thresholdLabels": false,
                        "thresholdMarkers": true
                      },
                      "gridPos": {
                        "h": 5,
                        "w": 6,
                        "x": 18,
                        "y": 9
                      },
                      "id": 5,
                      "interval": null,
                      "links": [],
                      "mappingType": 1,
                      "mappingTypes": [
                        {
                          "name": "value to text",
                          "value": 1
                        },
                        {
                          "name": "range to text",
                          "value": 2
                        }
                      ],
                      "maxDataPoints": 100,
                      "nullPointMode": "connected",
                      "nullText": null,
                      "postfix": "",
                      "postfixFontSize": "50%",
                      "prefix": "",
                      "prefixFontSize": "50%",
                      "rangeMaps": [
                        {
                          "from": "null",
                          "text": "N/A",
                          "to": "null"
                        }
                      ],
                      "sparkline": {
                        "fillColor": "rgba(31, 118, 189, 0.18)",
                        "full": false,
                        "lineColor": "rgb(31, 120, 193)",
                        "show": false
                      },
                      "tableColumn": "Value",
                      "targets": [
                        {
                          "expr": "sum(petclinic_visit_seconds_count{method=\"read\", exception=\"none\"})",
                          "format": "time_series",
                          "instant": true,
                          "intervalFactor": 1,
                          "legendFormat": "",
                          "refId": "A"
                        }
                      ],
                      "thresholds": "",
                      "title": "Visit Created",
                      "type": "singlestat",
                      "valueFontSize": "80%",
                      "valueMaps": [
                        {
                          "op": "=",
                          "text": "N/A",
                          "value": "null"
                        }
                      ],
                      "valueName": "avg"
                    },
                    {
                      "aliasColors": {},
                      "bars": true,
                      "dashLength": 10,
                      "dashes": false,
                      "datasource": "Prometheus",
                      "fill": 1,
                      "gridPos": {
                        "h": 8,
                        "w": 24,
                        "x": 0,
                        "y": 14
                      },
                      "id": 7,
                      "legend": {
                        "alignAsTable": false,
                        "avg": false,
                        "current": false,
                        "hideEmpty": false,
                        "hideZero": true,
                        "max": true,
                        "min": false,
                        "rightSide": false,
                        "show": true,
                        "total": false,
                        "values": true
                      },
                      "lines": false,
                      "linewidth": 1,
                      "links": [],
                      "nullPointMode": "null",
                      "percentage": false,
                      "pointradius": 5,
                      "points": false,
                      "renderer": "flot",
                      "seriesOverrides": [],
                      "spaceLength": 10,
                      "stack": true,
                      "steppedLine": false,
                      "targets": [
                        {
                          "expr": "sum(petclinic_owner_seconds_count{method=\"createOwner\", exception=\"none\"})",
                          "format": "time_series",
                          "instant": false,
                          "intervalFactor": 1,
                          "legendFormat": "owner create",
                          "refId": "A"
                        },
                        {
                          "expr": "sum(petclinic_pet_seconds_count{method=\"processCreationForm\", exception=\"none\"})",
                          "format": "time_series",
                          "intervalFactor": 1,
                          "legendFormat": "pet create",
                          "refId": "B"
                        },
                        {
                          "expr": "sum(petclinic_visit_seconds_count{method=\"create\", exception=\"none\"})",
                          "format": "time_series",
                          "intervalFactor": 1,
                          "legendFormat": "visit create",
                          "refId": "C"
                        },
                        {
                          "expr": "sum(petclinic_owner_seconds_count{method=\"updateOwner\", exception=\"none\"})",
                          "format": "time_series",
                          "intervalFactor": 1,
                          "legendFormat": "owner update",
                          "refId": "D"
                        }
                      ],
                      "thresholds": [],
                      "timeFrom": null,
                      "timeShift": null,
                      "title": "SPC Business Histogram",
                      "tooltip": {
                        "shared": true,
                        "sort": 0,
                        "value_type": "individual"
                      },
                      "type": "graph",
                      "xaxis": {
                        "buckets": null,
                        "mode": "time",
                        "name": null,
                        "show": true,
                        "values": []
                      },
                      "yaxes": [
                        {
                          "format": "short",
                          "label": null,
                          "logBase": 1,
                          "max": null,
                          "min": null,
                          "show": true
                        },
                        {
                          "format": "short",
                          "label": null,
                          "logBase": 1,
                          "max": null,
                          "min": null,
                          "show": true
                        }
                      ]
                    }
                  ],
                  "refresh": "30s",
                  "schemaVersion": 16,
                  "style": "dark",
                  "tags": [],
                  "templating": {
                    "list": [
                      {
                        "auto": true,
                        "auto_count": 1,
                        "auto_min": "10s",
                        "current": {
                          "text": "auto",
                          "value": "$__auto_interval_timeRange"
                        },
                        "hide": 0,
                        "label": null,
                        "name": "timeRange",
                        "options": [
                          {
                            "selected": true,
                            "text": "auto",
                            "value": "$__auto_interval_timeRange"
                          },
                          {
                            "selected": false,
                            "text": "1m",
                            "value": "1m"
                          },
                          {
                            "selected": false,
                            "text": "10m",
                            "value": "10m"
                          },
                          {
                            "selected": false,
                            "text": "30m",
                            "value": "30m"
                          },
                          {
                            "selected": false,
                            "text": "1h",
                            "value": "1h"
                          },
                          {
                            "selected": false,
                            "text": "6h",
                            "value": "6h"
                          },
                          {
                            "selected": false,
                            "text": "12h",
                            "value": "12h"
                          },
                          {
                            "selected": false,
                            "text": "1d",
                            "value": "1d"
                          },
                          {
                            "selected": false,
                            "text": "7d",
                            "value": "7d"
                          },
                          {
                            "selected": false,
                            "text": "14d",
                            "value": "14d"
                          },
                          {
                            "selected": false,
                            "text": "30d",
                            "value": "30d"
                          }
                        ],
                        "query": "1m,10m,30m,1h,6h,12h,1d,7d,14d,30d",
                        "refresh": 2,
                        "type": "interval"
                      }
                    ]
                  },
                  "time": {
                    "from": "now-1h",
                    "to": "now"
                  },
                  "timepicker": {
                    "refresh_intervals": [
                      "5s",
                      "10s",
                      "30s",
                      "1m",
                      "5m",
                      "15m",
                      "30m",
                      "1h",
                      "2h",
                      "1d"
                    ],
                    "time_options": [
                      "5m",
                      "15m",
                      "1h",
                      "6h",
                      "12h",
                      "24h",
                      "2d",
                      "7d",
                      "30d"
                    ]
                  },
                  "timezone": "",
                  "title": "Spring Petclinic Metrics",
                  "uid": "69JXeR0iw",
                  "version": 1
                }
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true